<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>محرك المستندات الذكي</title>

  <!-- Optional: nicer Arabic font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <!-- Client-side PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg: #0b1020;              /* deep slate */
      --bg2:#0f1733;              /* slightly lighter */
      --card:#0f1a36;             /* card surface */
      --card2:#0d1730;            /* secondary surface */
      --text:#e8eefc;
      --muted:#a8b3d6;
      --border: rgba(255,255,255,.10);

      --brand:#6d5efc;            /* indigo */
      --brand2:#2ad4ff;           /* cyan */
      --ok:#35d07f;
      --warn:#ffcc66;
      --bad:#ff5c7a;

      --radius: 20px;
      --shadow: 0 24px 70px rgba(0,0,0,.45);
      --font: "Tajawal", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
    }

    *{ box-sizing:border-box }
    body{
      margin:0; font-family:var(--font); color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 85% 12%, rgba(109,94,252,.35), transparent 55%),
        radial-gradient(800px 420px at 12% 30%, rgba(42,212,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      padding: 28px;
      display:flex; align-items:center; justify-content:center;
    }

    .app{
      width:min(1100px, 100%);
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:18px;
    }
    @media (max-width: 980px){ .app{ grid-template-columns:1fr; } }

    .panel{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topbar{
      padding:18px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(90deg, rgba(109,94,252,.10), rgba(42,212,255,.06));
    }

    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      display:grid; place-items:center;
      font-weight:900; letter-spacing:.5px;
      box-shadow: 0 12px 30px rgba(109,94,252,.25);
    }
    .brand h1{
      margin:0;
      font-size:16px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .brand .desc{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }

    .ghost{
      background: transparent;
      border:1px solid var(--border);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      display:flex; align-items:center; gap:8px;
    }
    .ghost:hover{ border-color: rgba(255,255,255,.18); }

    .content{
      padding: 18px 20px 20px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 520px){ .grid2{ grid-template-columns:1fr; } }

    .drop{
      border:1px dashed rgba(255,255,255,.22);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: 18px;
      padding: 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      transition:.15s ease;
    }
    .drop.drag{
      border-color: rgba(42,212,255,.55);
      box-shadow: 0 0 0 6px rgba(42,212,255,.08);
    }
    .drop .t{
      font-weight:900;
      font-size:13px;
    }
    .drop .m{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      line-height:1.7;
    }
    .fileline{
      margin-top:8px;
      font-size:12px;
      color: rgba(232,238,252,.92);
      font-weight:800;
    }

    input[type="file"]{ display:none; }

    .btn{
      border:0;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
      color:#0a1022;
      background: rgba(255,255,255,.92);
    }
    .btn:hover{ background: rgba(255,255,255,.98); }

    .btn2{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
      color: var(--text);
      background: rgba(255,255,255,.04);
    }
    .btn2:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.18); }

    .field{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .field label{ font-size:12px; color: var(--muted); font-weight:700; }
    select{
      border:0; outline:0;
      background: transparent;
      color: var(--text);
      font-family: var(--font);
      font-weight:900;
      cursor:pointer;
    }

    .run{
      margin-top:14px;
      width:100%;
      height:48px;
      border-radius: 16px;
      border:0;
      cursor:pointer;
      font-weight:900;
      color:#0a1022;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 18px 55px rgba(109,94,252,.25);
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .run:disabled{
      opacity:.5; cursor:not-allowed; box-shadow:none;
    }
    .spin{
      width:16px; height:16px; border-radius:50%;
      border:2px solid rgba(10,16,34,.25);
      border-top-color: rgba(10,16,34,.85);
      animation: r 1s linear infinite;
      display:none;
    }
    .run.loading .spin{ display:inline-block; }
    @keyframes r { to{ transform: rotate(360deg); } }

    /* Right panel */
    .rightTitle{
      padding: 16px 18px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .rightTitle h2{
      margin:0;
      font-size:13px;
      font-weight:900;
      color: rgba(232,238,252,.95);
    }
    .pill{
      font-size:11px;
      font-weight:900;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      white-space:nowrap;
    }

    .resultWrap{
      padding: 16px 18px 18px;
    }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-bottom:12px;
    }
    @media (max-width: 520px){ .kpis{ grid-template-columns:1fr; } }

    .kpi{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
    }
    .kpi .k{ font-size:11px; color: var(--muted); font-weight:700; }
    .kpi .v{ margin-top:5px; font-size:13px; font-weight:900; }

    .block{
      margin-top:10px;
    }
    .block .h{
      font-size:12px;
      font-weight:900;
      margin-bottom:8px;
      color: rgba(232,238,252,.95);
      display:flex; align-items:center; justify-content:space-between;
    }
    .box{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      padding: 12px;
      font-size:13px;
      line-height:1.9;
      color: rgba(232,238,252,.92);
      white-space: pre-wrap;
      min-height: 90px;
    }

    .actions{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:14px;
    }

    .toast{
      margin-top:10px;
      font-size:12px;
      font-weight:900;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }
    .toast.ok{ color: rgba(53,208,127,.95); border-color: rgba(53,208,127,.22); background: rgba(53,208,127,.06); }
    .toast.err{ color: rgba(255,92,122,.95); border-color: rgba(255,92,122,.22); background: rgba(255,92,122,.06); }
  </style>
</head>

<body>
  <div class="app">

    <!-- Left: Upload + Run -->
    <div class="panel">
      <div class="topbar">
        <div class="brand">
          <div class="logo">AI</div>
          <div>
            <h1>محرك المستندات الذكي</h1>
            <div class="desc">ارفع ملف PDF وسأتعرف على نوعه وأنتج ملخصًا وقرارًا ومخرجات قابلة للحفظ والتنزيل.</div>
          </div>
        </div>

        <button id="demoBtn" class="ghost" type="button">عرض تجريبي</button>
      </div>

      <div class="content">
        <div id="drop" class="drop">
          <div>
            <div class="t">رفع ملف (PDF)</div>
            <div class="m">اسحب الملف هنا أو اختره من جهازك.</div>
            <div id="fileName" class="fileline"></div>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <label class="btn" for="file">اختيار ملف</label>
            <input id="file" type="file" accept="application/pdf" />
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>مستوى الإخراج</label>
            <select id="detail">
              <option value="short">مختصر</option>
              <option value="balanced" selected>متوازن</option>
              <option value="deep">مفصل</option>
            </select>
          </div>

          <div class="field">
            <label>لغة الإخراج</label>
            <select id="lang">
              <option value="ar" selected>العربية</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>

        <button id="runBtn" class="run" type="button" disabled>
          <span class="spin"></span>
          <span id="runText">تشغيل</span>
        </button>

        <div id="toast" class="toast" style="display:none;"></div>
      </div>
    </div>

    <!-- Right: Results -->
    <div class="panel">
      <div class="rightTitle">
        <h2>النتيجة</h2>
        <div id="statePill" class="pill">جاهز</div>
      </div>

      <div class="resultWrap">
        <div class="kpis">
          <div class="kpi">
            <div class="k">نوع المستند</div>
            <div id="docType" class="v">—</div>
          </div>
          <div class="kpi">
            <div class="k">القرار</div>
            <div id="decision" class="v">—</div>
          </div>
          <div class="kpi">
            <div class="k">الثقة</div>
            <div id="confidence" class="v">—</div>
          </div>
        </div>

        <div class="block" id="pdfArea">
          <div class="h">ملخص</div>
          <div id="summary" class="box">—</div>
        </div>

        <div class="block">
          <div class="h">نقاط تنفيذية</div>
          <div id="actionsList" class="box">—</div>
        </div>

        <div class="actions">
          <button id="downloadBtn" class="btn2" type="button" style="display:none;">تنزيل PDF</button>
          <button id="saveBtn" class="btn2" type="button" style="display:none;">حفظ النتيجة</button>
          <button id="copyBtn" class="btn2" type="button" style="display:none;">نسخ الملخص</button>
        </div>
      </div>
    </div>

  </div>

<script>
  
  const WEBHOOK_URL = "https://falshasafey.app.n8n.cloud/webhook/4bb681f6-fadf-44cc-8ff7-74a23a226c9d";

  const drop = document.getElementById("drop");
  const fileInput = document.getElementById("file");
  const fileNameEl = document.getElementById("fileName");
  const runBtn = document.getElementById("runBtn");
  const runText = document.getElementById("runText");
  const detail = document.getElementById("detail");
  const lang = document.getElementById("lang");
  const demoBtn = document.getElementById("demoBtn");

  const statePill = document.getElementById("statePill");
  const toast = document.getElementById("toast");

  const docTypeEl = document.getElementById("docType");
  const decisionEl = document.getElementById("decision");
  const confidenceEl = document.getElementById("confidence");
  const summaryEl = document.getElementById("summary");
  const actionsListEl = document.getElementById("actionsList");

  const downloadBtn = document.getElementById("downloadBtn");
  const saveBtn = document.getElementById("saveBtn");
  const copyBtn = document.getElementById("copyBtn");

  let selectedFile = null;
  let lastData = null;

  function setState(text){
    statePill.textContent = text;
  }

  function showToast(type, msg){
    toast.style.display = "block";
    toast.className = "toast " + (type || "");
    toast.textContent = msg;
  }

  function hideToast(){
    toast.style.display = "none";
  }

  function clearOutput(){
    docTypeEl.textContent = "—";
    decisionEl.textContent = "—";
    confidenceEl.textContent = "—";
    summaryEl.textContent = "—";
    actionsListEl.textContent = "—";
    downloadBtn.style.display = "none";
    saveBtn.style.display = "none";
    copyBtn.style.display = "none";
    lastData = null;
  }

  function setLoading(on){
    runBtn.classList.toggle("loading", on);
    runBtn.disabled = on || !selectedFile;
    runText.textContent = on ? "جاري التنفيذ…" : "تشغيل";
    setState(on ? "قيد المعالجة" : "جاهز");
  }

  function acceptFile(file){
    hideToast();
    clearOutput();

    if(!file) return;
    if(file.type !== "application/pdf"){
      showToast("err", "الملف يجب أن يكون PDF.");
      selectedFile = null;
      fileNameEl.textContent = "";
      runBtn.disabled = true;
      return;
    }
    selectedFile = file;
    fileNameEl.textContent = `تم اختيار: ${file.name}`;
    runBtn.disabled = false;
    setState("جاهز");
  }

  // Drag & drop
  ["dragenter","dragover"].forEach(evt => {
    drop.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      drop.classList.add("drag");
    });
  });
  ["dragleave","drop"].forEach(evt => {
    drop.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      drop.classList.remove("drag");
    });
  });
  drop.addEventListener("drop", e => {
    const f = e.dataTransfer.files?.[0];
    acceptFile(f);
  });

  fileInput.addEventListener("change", e => acceptFile(e.target.files?.[0]));

  async function run(){
    if(!selectedFile) return;
    hideToast();
    clearOutput();
    setLoading(true);

    try{
      const form = new FormData();
      form.append("file", selectedFile, selectedFile.name);
      form.append("detail", detail.value);
      form.append("lang", lang.value);

      const res = await fetch(WEBHOOK_URL, { method:"POST", body: form });
      if(!res.ok){
        const t = await res.text();
        throw new Error(t || `HTTP ${res.status}`);
      }

      const data = await res.json();
      // Expected:
      // { document_type, decision, confidence, summary, action_items, extracted_fields?, outputs? }

      lastData = {
        document_type: data.document_type || "Other",
        decision: data.decision || "summarize_only",
        confidence: (typeof data.confidence === "number") ? data.confidence : null,
        summary: (data.summary || "").trim(),
        action_items: Array.isArray(data.action_items) ? data.action_items : []
      };

      docTypeEl.textContent = lastData.document_type;
      decisionEl.textContent = lastData.decision;
      confidenceEl.textContent = (lastData.confidence != null)
        ? `${Math.round(lastData.confidence * 100)}%`
        : "—";

      summaryEl.textContent = lastData.summary || "—";
      actionsListEl.textContent = lastData.action_items.length
        ? lastData.action_items.map((x,i)=> `${i+1}) ${x}`).join("\n")
        : "—";

      // Enable actions
      if(lastData.summary){
        downloadBtn.style.display = "inline-flex";
        saveBtn.style.display = "inline-flex";
        copyBtn.style.display = "inline-flex";
      }

      setState("تم");
      showToast("ok", "اكتملت المعالجة.");
    }catch(err){
      setState("خطأ");
      showToast("err", `فشل التنفيذ: ${String(err.message || err).slice(0, 200)}`);
    }finally{
      setLoading(false);
    }
  }

  runBtn.addEventListener("click", run);

  // Save locally (last 20)
  function saveResult(payload){
    const saved = JSON.parse(localStorage.getItem("saved_results") || "[]");
    saved.unshift({
      id: crypto.randomUUID(),
      date: new Date().toISOString(),
      ...payload
    });
    localStorage.setItem("saved_results", JSON.stringify(saved.slice(0, 20)));
  }

  saveBtn.addEventListener("click", () => {
    if(!lastData) return;
    saveResult(lastData);
    showToast("ok", "تم حفظ النتيجة على هذا الجهاز.");
  });

  copyBtn.addEventListener("click", async () => {
    if(!lastData?.summary) return;
    try{
      await navigator.clipboard.writeText(lastData.summary);
      showToast("ok", "تم نسخ الملخص.");
    }catch(e){
      showToast("err", "تعذر النسخ.");
    }
  });

  // Download PDF (client-side)
  downloadBtn.addEventListener("click", () => {
    if(!lastData) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    // Basic PDF layout (Arabic shaping in PDFs is tricky; this keeps it simple)
    // If you want perfect Arabic in PDF: generate on server (n8n) بدلًا من المتصفح.
    const margin = 44;
    const lineH = 16;
    let y = 60;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("Document Automation Result", margin, y);
    y += 22;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text(`Type: ${lastData.document_type}`, margin, y); y += lineH;
    doc.text(`Decision: ${lastData.decision}`, margin, y); y += lineH;
    doc.text(`Confidence: ${lastData.confidence != null ? Math.round(lastData.confidence*100)+'%' : '-'}`, margin, y); y += 18;

    doc.setFont("helvetica", "bold");
    doc.text("Summary:", margin, y); y += 16;
    doc.setFont("helvetica", "normal");

    const summaryLines = doc.splitTextToSize(lastData.summary || "-", 520);
    doc.text(summaryLines, margin, y);
    y += summaryLines.length * lineH + 14;

    doc.setFont("helvetica", "bold");
    doc.text("Action Items:", margin, y); y += 16;
    doc.setFont("helvetica", "normal");

    const itemsText = (lastData.action_items || []).map((x,i)=> `${i+1}) ${x}`).join("\n") || "-";
    const itemsLines = doc.splitTextToSize(itemsText, 520);
    doc.text(itemsLines, margin, y);

    const name = (selectedFile?.name || "result").replace(/\.pdf$/i, "");
    doc.save(`${name}-result.pdf`);
  });

  // Demo
  demoBtn.addEventListener("click", () => {
    hideToast();
    selectedFile = { name: "demo.pdf", type: "application/pdf" };
    fileNameEl.textContent = "تم اختيار: demo.pdf";
    runBtn.disabled = false;

    lastData = {
      document_type: "Report",
      decision: "archive",
      confidence: 0.92,
      summary: "• ملخص تنفيذي سريع.\n• أبرز النقاط المستخلصة من المستند.\n• توصيات قابلة للتنفيذ.",
      action_items: ["أرشفة المستند في مجلد التقارير", "إرسال ملخص للجهة المعنية", "إنشاء مهمة متابعة خلال أسبوع"]
    };

    docTypeEl.textContent = lastData.document_type;
    decisionEl.textContent = lastData.decision;
    confidenceEl.textContent = "92%";
    summaryEl.textContent = lastData.summary;
    actionsListEl.textContent = lastData.action_items.map((x,i)=> `${i+1}) ${x}`).join("\n");

    downloadBtn.style.display = "inline-flex";
    saveBtn.style.display = "inline-flex";
    copyBtn.style.display = "inline-flex";

    setState("تجربة");
    showToast("ok", "عرض تجريبي.");
  });

  clearOutput();
  setState("جاهز");
</script>
</body>
</html>
