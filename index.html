<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مساعد المستندات الذكي</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #f9fafb 45%, #eef2ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      color: #0f172a;
    }

    .shell {
      width: 100%;
      max-width: 980px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 24px;
    }

    @media (max-width: 840px) {
      .shell {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: #ffffff;
      border-radius: 24px;
      padding: 22px 22px 20px;
      box-shadow: 0 22px 60px rgba(15,23,42,0.17);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset-inline-start: -60px;
      inset-block-start: -80px;
      width: 180px;
      height: 180px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(45,212,191,0.15), transparent 60%);
      pointer-events: none;
    }

    .header-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .logo-badge {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, #22c55e, #14b8a6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ecfeff;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 10px 25px rgba(5,150,105,0.4);
    }

    .title {
      font-size: 22px;
      font-weight: 800;
      margin: 0 0 2px;
    }

    .subtitle {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 16px;
    }

    .pill-row {
      display: inline-flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: #f1f5f9;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(15,118,110,0.25);
      color: #0f766e;
      background: #ecfeff;
      white-space: nowrap;
    }

    .pill span {
      font-weight: 700;
    }

    .field {
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      color: #475569;
    }

    .dropzone {
      position: relative;
      padding: 14px 12px;
      border-radius: 14px;
      border: 1px dashed #cbd5f5;
      background: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
      transition: border-color 0.15s ease, background 0.15s ease, box-shadow 0.15s ease;
    }

    .dropzone:hover {
      border-color: #0f766e;
      background: #f1f5f9;
      box-shadow: 0 0 0 1px rgba(15,118,110,0.25);
    }

    .drop-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 13px;
      color: #0f172a;
    }

    .drop-hint {
      font-size: 11px;
      color: #94a3b8;
    }

    .drop-btn {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #0f172a;
      color: #e2e8f0;
      white-space: nowrap;
    }

    input[type="file"] {
      display: none;
    }

    button {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 11px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #0f766e, #14b8a6);
      color: #ecfeff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s ease;
      box-shadow: 0 14px 32px rgba(15,118,110,0.45);
      margin-top: 8px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(15,118,110,0.5);
    }

    button:disabled {
      opacity: 0.65;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #64748b;
      min-height: 16px;
    }

    .status.error {
      color: #b91c1c;
    }

    .result-card {
      background: #020617;
      color: #e2e8f0;
      border-radius: 24px;
      padding: 20px 20px 18px;
      box-shadow: 0 22px 60px rgba(15,23,42,0.7);
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .result-title {
      font-size: 15px;
      font-weight: 700;
    }

    .badge-type {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15,118,110,0.2);
      border: 1px solid rgba(34,197,94,0.6);
      color: #bbf7d0;
    }

    .metric-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .metric {
      font-size: 11px;
      padding: 6px 9px;
      border-radius: 12px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
    }

    .metric span {
      color: #e5e7eb;
      font-weight: 600;
    }

    .result-section-title {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .result-text {
      font-size: 11px;
      line-height: 1.7;
      color: #e5e7eb;
      max-height: 132px;
      overflow: auto;
      padding-inline-end: 4px;
    }

    .result-text::-webkit-scrollbar {
      width: 4px;
    }
    .result-text::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 999px;
    }

    .result-footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 10px;
      color: #9ca3af;
    }

    .result-footer button {
      width: auto;
      padding-inline: 12px;
      box-shadow: none;
      font-size: 11px;
      margin-top: 0;
    }
  </style>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="shell">
    <!-- الفورم -->
    <div class="card">
      <div class="header-row">
        <div class="logo-badge">AI</div>
        <div>
          <p class="title">مساعد المستندات الذكي</p>
          <p class="subtitle">قم برفع ملف PDF واحد فقط، وخذ تقرير تحليلي جاهز تلقائيًا.</p>
        </div>
      </div>

      <div class="pill-row">
        <div class="pill"><span>CV</span> – تقييم ATS نصائح</div>
        <div class="pill"><span>Chapters</span> – تلخيص محاضرات وفصول</div>
        <div class="pill"><span>Invoices</span> – استخراج أهم بيانات الفاتورة</div>
      </div>

      <form id="docForm">
        <div class="field">
          <label for="file">الملف (PDF فقط)</label>
          <div class="dropzone" id="dropzone">
            <div class="drop-main">
              <span id="fileLabel">اسحب ملف الـ PDF هنا أو اضغط لإختياره</span>
              <span class="drop-hint">يتم التعرف تلقائيًا إن كان CV أو فصل أو فاتورة.</span>
            </div>
            <div class="drop-btn">اختيار ملف</div>
            <input type="file" id="file" name="file" accept=".pdf" />
          </div>
        </div>

        <button type="submit" id="submitBtn">
          <span id="btnText">تحليل المستند الآن</span>
          <span id="btnSpinner" style="display:none;">…</span>
        </button>

        <div class="status" id="status"></div>
      </form>
    </div>

    <!-- النتيجة -->
    <div class="result-card" id="resultCard" style="opacity:0.35; filter:grayscale(0.4);">
      <div class="result-header">
        <div class="result-title">نتيجة التحليل</div>
        <div class="badge-type" id="resultType">لم يتم التحليل بعد</div>
      </div>

      <div class="metric-row" id="metricRow">
        <div class="metric">نوع المستند: —</div>
        <div class="metric">درجة ATS: —</div>
        <div class="metric">العناصر المستخرجة: —</div>
      </div>

      <div class="result-section-title">ملخص مختصر</div>
      <div class="result-text" id="resultSummary">
        بعد رفع ملف PDF والضغط على "تحليل المستند الآن" سيظهر هنا ملخص ذكي للمحتوى.
      </div>

      <div class="result-footer">
        <span id="resultHint">سيتم توليد تقرير PDF جاهز للحفظ أو المشاركة.</span>
        <button type="button" id="downloadAgainBtn" disabled>تحميل التقرير مرة أخرى</button>
      </div>
    </div>
  </div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    console.log("Smart Doc Assistant script loaded ✅");

    const WEBHOOK_URL = "https://falshasafey.app.n8n.cloud/webhook/4bb681f6-fadf-44cc-8ff7-74a23a226c9d";

    const form = document.getElementById("docForm");
    const fileInput = document.getElementById("file");
    const fileLabel = document.getElementById("fileLabel");
    const dropzone = document.getElementById("dropzone");

    const statusEl = document.getElementById("status");
    const btn = document.getElementById("submitBtn");
    const btnText = document.getElementById("btnText");
    const btnSpinner = document.getElementById("btnSpinner");

    const resultCard = document.getElementById("resultCard");
    const resultTypeEl = document.getElementById("resultType");
    const metricRow = document.getElementById("metricRow");
    const resultSummary = document.getElementById("resultSummary");
    const resultHint = document.getElementById("resultHint");
    const downloadAgainBtn = document.getElementById("downloadAgainBtn");

    let lastAnalysisData = null;

    // لو في عنصر ناقص نعرف مباشرة
    if (!form || !fileInput || !fileLabel || !dropzone) {
      console.error("❌ عناصر ناقصة:", { form, fileInput, fileLabel, dropzone });
      return;
    }

    function setStatus(text, isError) {
      statusEl.textContent = text || "";
      statusEl.classList.toggle("error", !!isError);
    }

    function activateResultCard(active) {
      if (!resultCard) return;
      if (active) {
        resultCard.style.opacity = "1";
        resultCard.style.filter = "none";
      } else {
        resultCard.style.opacity = "0.35";
        resultCard.style.filter = "grayscale(0.4)";
      }
    }

    function mapType(type) {
      if (type === "cv") return "سيرة ذاتية (CV)";
      if (type === "chapter") return "فصل / محاضرة";
      if (type === "invoice") return "فاتورة";
      return "مستند عام";
    }

    function renderAnalysis(data) {
      if (!resultCard) return;
      lastAnalysisData = data;
      activateResultCard(true);

      const type = data.type || "generic";
      const typeLabel = mapType(type);

      resultTypeEl.textContent = typeLabel;
      metricRow.innerHTML = "";

      const metricType = document.createElement("div");
      metricType.className = "metric";
      metricType.textContent = "نوع المستند: " + typeLabel;
      metricRow.appendChild(metricType);

      if (type === "cv") {
        const ats = document.createElement("div");
        ats.className = "metric";
        ats.innerHTML = "<span>ATS Score:</span> " + (data.atsScore ?? "غير محدد");
        metricRow.appendChild(ats);

        const missing = document.createElement("div");
        missing.className = "metric";
        const count = (data.skillsMissing && data.skillsMissing.length) || 0;
        missing.innerHTML = "<span>مهارات ناقصة:</span> " + count;
        metricRow.appendChild(missing);
      }

      if (type === "chapter") {
        const kp = document.createElement("div");
        kp.className = "metric";
        const count = (data.keyPoints && data.keyPoints.length) || 0;
        kp.innerHTML = "<span>أهم النقاط:</span> " + count;
        metricRow.appendChild(kp);
      }

      if (type === "invoice" && data.invoice) {
        const inv = data.invoice;
        const items = document.createElement("div");
        items.className = "metric";
        items.innerHTML = "<span>عدد العناصر:</span> " + ((inv.items && inv.items.length) || 0);
        metricRow.appendChild(items);

        const total = document.createElement("div");
        total.className = "metric";
        total.innerHTML = "<span>المجموع:</span> " + (inv.total || "—");
        metricRow.appendChild(total);
      }

      resultSummary.textContent = data.summary || "لم يرجع الذكاء ملخصًا واضحًا لهذا المستند.";
      resultHint.textContent = "تم توليد التقرير. بإمكانك حفظ ملف PDF للرجوع لاحقًا.";
      downloadAgainBtn.disabled = false;
    }

    function generatePdfFromAnalysis(data) {
      const jsPDF = window.jspdf && window.jspdf.jsPDF;
      if (!jsPDF) {
        console.warn("jsPDF not loaded");
        return;
      }

      const doc = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });
      const marginX = 48;
      let y = 54;

      doc.setFontSize(18);
      doc.text("تقرير مساعد المستندات الذكي", marginX, y);
      y += 28;

      doc.setFontSize(11);

      const type = data.type || "generic";
      const typeLabel = mapType(type);

      doc.text("نوع المستند: " + typeLabel, marginX, y);
      y += 18;

      function addParagraph(title, text) {
        if (!text) return;
        doc.text(title, marginX, y);
        y += 14;
        const lines = doc.splitTextToSize(text, 500);
        doc.text(lines, marginX, y);
        y += lines.length * 14 + 14;
      }

      if (type === "cv") {
        if (data.atsScore != null) {
          doc.text("ATS Score: " + data.atsScore, marginX, y);
          y += 18;
        }
        addParagraph("الملخص:", data.summary || "");

        if (data.skillsMissing && data.skillsMissing.length) {
          addParagraph("المهارات الناقصة:", data.skillsMissing.map(s => "- " + s).join("\n"));
        }

        if (data.suggestions && data.suggestions.length) {
          addParagraph("اقتراحات للتحسين:", data.suggestions.map(s => "- " + s).join("\n"));
        }
      } else if (type === "chapter") {
        addParagraph("الملخص:", data.summary || "");
        if (data.keyPoints && data.keyPoints.length) {
          addParagraph("أهم النقاط:", data.keyPoints.map(p => "- " + p).join("\n"));
        }
        if (data.suggestions && data.suggestions.length) {
          addParagraph("اقتراحات:", data.suggestions.map(s => "- " + s).join("\n"));
        }
      } else if (type === "invoice" && data.invoice) {
        const inv = data.invoice;
        addParagraph(
          "بيانات الفاتورة:",
          "البائع: " + (inv.seller || "—") + "\n" +
          "المشتري: " + (inv.buyer || "—") + "\n" +
          "التاريخ: " + (inv.date || "—")
        );

        if (inv.items && inv.items.length) {
          addParagraph("العناصر:", inv.items.map(it => "- " + it).join("\n"));
        }

        addParagraph(
          "المبالغ:",
          "المجموع: " + (inv.total || "—") + "\n" +
          "الضريبة: " + (inv.tax || "—")
        );

        if (inv.notes) {
          addParagraph("ملاحظات:", inv.notes);
        }
      } else {
        addParagraph("الملخص:", data.summary || "");
      }

      doc.save("smart-document-report.pdf");
    }

    // ✅ اختيار الملف
    dropzone.addEventListener("click", function () {
      console.log("Dropzone clicked");
      fileInput.click();
    });

    fileInput.addEventListener("change", function () {
      console.log("File input changed", fileInput.files);
      if (fileInput.files && fileInput.files[0]) {
        fileLabel.textContent = fileInput.files[0].name;
        setStatus("تم اختيار الملف ✅");
      } else {
        fileLabel.textContent = "اسحبي ملف الـ PDF هنا أو اضغطي لاختياره";
        setStatus("");
      }
    });

    downloadAgainBtn.addEventListener("click", function () {
      if (lastAnalysisData) generatePdfFromAnalysis(lastAnalysisData);
    });

    // ✅ إرسال الفورم
    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      setStatus("");

      console.log("Form submitted");

      if (!fileInput.files || fileInput.files.length === 0) {
        setStatus("اختاري ملف PDF أولاً.", true);
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      btn.disabled = true;
      btnText.textContent = "جاري التحليل...";
      btnSpinner.style.display = "inline-block";
      setStatus("قد يستغرق التحليل عدة ثوانٍ حسب حجم الملف.");

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          body: formData
        });

        const raw = await res.text();
        console.log("RAW STATUS", res.status);
        console.log("RAW BODY", raw.slice(0, 200));

        if (!res.ok) {
          throw new Error("خطأ في السيرفر (" + res.status + ")");
        }

        let data;
        try {
          data = JSON.parse(raw);
        } catch (e) {
          console.error("JSON parse error", e);
          throw new Error("الرد من السيرفر ليس JSON صالح.");
        }

        renderAnalysis(data);
        generatePdfFromAnalysis(data);
        setStatus("تم توليد التقرير بنجاح.");
      } catch (err) {
        console.error(err);
        setStatus(err.message || "صار خطأ أثناء التحليل.", true);
      } finally {
        btn.disabled = false;
        btnText.textContent = "تحليل المستند الآن";
        btnSpinner.style.display = "none";
      }
    });
  });
</script>
</body>
</html>
